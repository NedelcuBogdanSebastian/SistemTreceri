/*************************************************************************************
    Copyright (C) 2024 Nedelcu Bogdan Sebastian
    This code is free software: you can redistribute it and/or modify it 
    under the following conditions:
    1. The use, distribution, and modification of this file are permitted for any 
       purpose, provided that the following conditions are met:
    2. Any redistribution or modification of this file must retain the original 
       copyright notice, this list of conditions, and the following attribution:
       "Original work by Nedelcu Bogdan Sebastian."
    3. The original author provides no warranty regarding the functionality or fitness 
       of this software for any particular purpose. Use it at your own risk.
    By using this software, you agree to retain the name of the original author in any 
    derivative works or distributions.
    ------------------------------------------------------------------------
    This code is provided as-is, without any express or implied warranties.
**************************************************************************************/

/*
 * Here we generate sine waves with phases from 0 to 359 degrees.
 * We add noise to each signal and compute the phase angle from FFT.
 * We then print over USB SERIAL the initial signal phase and
 * the computed phase to further analyze with Python if needed.
 * It appears on the PC as a USB SERIAL device, and we can use Termite
 * to see the values.
 *
 * The values are scaled by a factor of 10000!
 */

#include "stm32f10x.h"
#include "math.h"
#include "string.h"
#include "stdlib.h"
#include "stdio.h"
#include "hw_config.h"
#include "usb_lib.h"
#include "usb_desc.h"
#include "usb_pwr.h"

// Flattop Window: If the purpose of the test focus more on the energy value of a
// certain periodic signal frequency point. For example for Upeak, Upeak-peak, Urms,
// then the accuracy of its amplitude is more important, and a window with slighty
// wider lobes is better.
// The Flat Top window has a flatter passband, which helps retain accurate amplitude
// and phase information, particularly when analyzing signals where frequency peaks
// must be well-isolated. Since the window decreases the leakage, the phase extraction
// becomes more accurate. However, keep in mind that this window broadens the peaks,
// so you might sacrifice some resolution in the frequency domain.
/*void generate_flat_top_window(float *window, size_t num_points) {
    // Flat Top window coefficients
    const float a0 = 1.0;
    const float a1 = 1.93;
    const float a2 = 1.29;
    const float a3 = 0.388;
    const float a4 = 0.028;

    for (size_t n = 0; n < num_points; n++) {
        // Compute the normalized index value
        float factor = (2 * PI * n) / (num_points - 1);

        // Apply the Flat Top window function
        window[n] = a0
                  - a1 * cos(factor)
                  + a2 * cos(2 * factor)
                  - a3 * cos(3 * factor)
                  + a4 * cos(4 * factor);
    }
}
*/
const float flattop_window[] = {
0.000000, -0.000001, -0.000004, -0.000008, -0.000014, -0.000022, -0.000032, -0.000043,
-0.000056, -0.000071, -0.000088, -0.000106, -0.000127, -0.000149, -0.000173, -0.000198,
-0.000226, -0.000255, -0.000286, -0.000319, -0.000354, -0.000390, -0.000429, -0.000469,
-0.000511, -0.000556, -0.000602, -0.000650, -0.000700, -0.000751, -0.000805, -0.000861,
-0.000919, -0.000978, -0.001040, -0.001104, -0.001170, -0.001238, -0.001308, -0.001380,
-0.001454, -0.001530, -0.001609, -0.001690, -0.001773, -0.001858, -0.001945, -0.002035,
-0.002127, -0.002221, -0.002317, -0.002416, -0.002517, -0.002621, -0.002727, -0.002836,
-0.002947, -0.003060, -0.003176, -0.003295, -0.003416, -0.003539, -0.003666, -0.003795,
-0.003926, -0.004061, -0.004198, -0.004338, -0.004480, -0.004626, -0.004774, -0.004926,
-0.005080, -0.005237, -0.005397, -0.005560, -0.005726, -0.005896, -0.006068, -0.006243,
-0.006422, -0.006604, -0.006789, -0.006977, -0.007169, -0.007364, -0.007562, -0.007764,
-0.007969, -0.008178, -0.008390, -0.008606, -0.008826, -0.009048, -0.009275, -0.009505,
-0.009740, -0.009977, -0.010219, -0.010465, -0.010714, -0.010967, -0.011224, -0.011486,
-0.011751, -0.012020, -0.012294, -0.012571, -0.012853, -0.013139, -0.013429, -0.013724,
-0.014022, -0.014326, -0.014633, -0.014945, -0.015262, -0.015583, -0.015908, -0.016239,
-0.016574, -0.016913, -0.017257, -0.017606, -0.017960, -0.018319, -0.018683, -0.019051,
-0.019424, -0.019803, -0.020186, -0.020575, -0.020968, -0.021367, -0.021771, -0.022180,
-0.022594, -0.023014, -0.023439, -0.023869, -0.024305, -0.024746, -0.025193, -0.025645,
-0.026103, -0.026567, -0.027036, -0.027510, -0.027991, -0.028477, -0.028968, -0.029466,
-0.029970, -0.030479, -0.030994, -0.031515, -0.032042, -0.032576, -0.033115, -0.033660,
-0.034212, -0.034769, -0.035333, -0.035903, -0.036479, -0.037061, -0.037650, -0.038245,
-0.038846, -0.039454, -0.040068, -0.040688, -0.041315, -0.041949, -0.042589, -0.043235,
-0.043888, -0.044548, -0.045215, -0.045887, -0.046567, -0.047253, -0.047946, -0.048646,
-0.049353, -0.050066, -0.050786, -0.051513, -0.052247, -0.052987, -0.053735, -0.054489,
-0.055250, -0.056018, -0.056794, -0.057576, -0.058365, -0.059161, -0.059964, -0.060774,
-0.061591, -0.062415, -0.063246, -0.064084, -0.064929, -0.065781, -0.066640, -0.067507,
-0.068380, -0.069261, -0.070148, -0.071043, -0.071945, -0.072854, -0.073770, -0.074693,
-0.075623, -0.076560, -0.077504, -0.078456, -0.079414, -0.080380, -0.081352, -0.082332,
-0.083319, -0.084312, -0.085313, -0.086321, -0.087336, -0.088357, -0.089386, -0.090422,
-0.091464, -0.092514, -0.093570, -0.094634, -0.095704, -0.096781, -0.097865, -0.098956,
-0.100053, -0.101157, -0.102268, -0.103386, -0.104510, -0.105641, -0.106779, -0.107923,
-0.109073, -0.110230, -0.111394, -0.112564, -0.113740, -0.114923, -0.116112, -0.117308,
-0.118509, -0.119717, -0.120931, -0.122151, -0.123377, -0.124609, -0.125847, -0.127090,
-0.128340, -0.129595, -0.130857, -0.132123, -0.133396, -0.134674, -0.135957, -0.137246,
-0.138541, -0.139840, -0.141145, -0.142455, -0.143770, -0.145090, -0.146415, -0.147745,
-0.149080, -0.150419, -0.151763, -0.153112, -0.154465, -0.155823, -0.157185, -0.158551,
-0.159922, -0.161296, -0.162675, -0.164057, -0.165443, -0.166833, -0.168227, -0.169624,
-0.171024, -0.172428, -0.173835, -0.175246, -0.176659, -0.178075, -0.179494, -0.180916,
-0.182341, -0.183767, -0.185197, -0.186628, -0.188062, -0.189498, -0.190936, -0.192375,
-0.193817, -0.195259, -0.196704, -0.198149, -0.199596, -0.201044, -0.202493, -0.203943,
-0.205393, -0.206844, -0.208295, -0.209747, -0.211199, -0.212651, -0.214102, -0.215554,
-0.217005, -0.218455, -0.219905, -0.221354, -0.222802, -0.224248, -0.225694, -0.227138,
-0.228580, -0.230020, -0.231459, -0.232895, -0.234330, -0.235762, -0.237191, -0.238617,
-0.240041, -0.241461, -0.242879, -0.244292, -0.245703, -0.247109, -0.248512, -0.249910,
-0.251304, -0.252694, -0.254078, -0.255459, -0.256834, -0.258203, -0.259568, -0.260927,
-0.262280, -0.263627, -0.264967, -0.266302, -0.267630, -0.268951, -0.270265, -0.271572,
-0.272872, -0.274164, -0.275449, -0.276725, -0.277993, -0.279253, -0.280504, -0.281747,
-0.282980, -0.284204, -0.285419, -0.286624, -0.287819, -0.289004, -0.290179, -0.291343,
-0.292497, -0.293639, -0.294771, -0.295891, -0.296999, -0.298095, -0.299179, -0.300251,
-0.301311, -0.302357, -0.303391, -0.304411, -0.305417, -0.306410, -0.307389, -0.308354,
-0.309304, -0.310240, -0.311160, -0.312065, -0.312955, -0.313830, -0.314688, -0.315530,
-0.316356, -0.317165, -0.317957, -0.318732, -0.319489, -0.320229, -0.320951, -0.321654,
-0.322340, -0.323006, -0.323654, -0.324282, -0.324891, -0.325480, -0.326049, -0.326598,
-0.327126, -0.327634, -0.328120, -0.328585, -0.329029, -0.329451, -0.329850, -0.330228,
-0.330582, -0.330914, -0.331222, -0.331508, -0.331769, -0.332006, -0.332219, -0.332408,
-0.332572, -0.332710, -0.332824, -0.332912, -0.332973, -0.333009, -0.333018, -0.333001,
-0.332957, -0.332885, -0.332786, -0.332659, -0.332504, -0.332320, -0.332108, -0.331867,
-0.331597, -0.331297, -0.330968, -0.330608, -0.330218, -0.329798, -0.329347, -0.328865,
-0.328351, -0.327806, -0.327228, -0.326619, -0.325977, -0.325302, -0.324594, -0.323853,
-0.323078, -0.322270, -0.321427, -0.320549, -0.319637, -0.318690, -0.317708, -0.316690,
-0.315637, -0.314547, -0.313421, -0.312259, -0.311059, -0.309822, -0.308548, -0.307236,
-0.305887, -0.304499, -0.303072, -0.301607, -0.300102, -0.298559, -0.296975, -0.295352,
-0.293689, -0.291985, -0.290241, -0.288456, -0.286630, -0.284762, -0.282853, -0.280901,
-0.278908, -0.276872, -0.274793, -0.272672, -0.270507, -0.268299, -0.266047, -0.263751,
-0.261411, -0.259026, -0.256597, -0.254123, -0.251603, -0.249038, -0.246428, -0.243771,
-0.241069, -0.238320, -0.235524, -0.232682, -0.229792, -0.226855, -0.223871, -0.220839,
-0.217758, -0.214630, -0.211453, -0.208227, -0.204953, -0.201629, -0.198256, -0.194834,
-0.191361, -0.187839, -0.184267, -0.180644, -0.176970, -0.173246, -0.169471, -0.165645,
-0.161767, -0.157837, -0.153856, -0.149823, -0.145737, -0.141600, -0.137409, -0.133166,
-0.128870, -0.124521, -0.120119, -0.115663, -0.111153, -0.106590, -0.101973, -0.097302,
-0.092576, -0.087796, -0.082961, -0.078072, -0.073127, -0.068128, -0.063073, -0.057963,
-0.052797, -0.047576, -0.042299, -0.036966, -0.031577, -0.026132, -0.020630, -0.015072,
-0.009458, -0.003786, 0.001942, 0.007727, 0.013569, 0.019468, 0.025424, 0.031438,
0.037510, 0.043638, 0.049825, 0.056069, 0.062371, 0.068731, 0.075149, 0.081625,
0.088159, 0.094752, 0.101402, 0.108111, 0.114879, 0.121705, 0.128589, 0.135532,
0.142534, 0.149595, 0.156714, 0.163892, 0.171129, 0.178425, 0.185779, 0.193193,
0.200665, 0.208197, 0.215787, 0.223436, 0.231145, 0.238912, 0.246739, 0.254624,
0.262569, 0.270572, 0.278635, 0.286756, 0.294937, 0.303176, 0.311475, 0.319832,
0.328248, 0.336723, 0.345257, 0.353850, 0.362501, 0.371211, 0.379980, 0.388807,
0.397692, 0.406636, 0.415639, 0.424699, 0.433818, 0.442995, 0.452230, 0.461523,
0.470875, 0.480283, 0.489750, 0.499273, 0.508855, 0.518494, 0.528190, 0.537943,
0.547754, 0.557621, 0.567545, 0.577525, 0.587562, 0.597655, 0.607805, 0.618011,
0.628272, 0.638590, 0.648962, 0.659391, 0.669875, 0.680413, 0.691007, 0.701656,
0.712358, 0.723115, 0.733927, 0.744793, 0.755712, 0.766684, 0.777710, 0.788790,
0.799922, 0.811107, 0.822344, 0.833634, 0.844976, 0.856369, 0.867814, 0.879311,
0.890859, 0.902457, 0.914105, 0.925805, 0.937555, 0.949353, 0.961202, 0.973100,
0.985047, 0.997042, 1.009086, 1.021178, 1.033318, 1.045505, 1.057739, 1.070021,
1.082349, 1.094723, 1.107143, 1.119610, 1.132121, 1.144677, 1.157277, 1.169923,
1.182612, 1.195345, 1.208121, 1.220940, 1.233802, 1.246705, 1.259651, 1.272639,
1.285667, 1.298735, 1.311845, 1.324995, 1.338184, 1.351411, 1.364678, 1.377985,
1.391328, 1.404709, 1.418127, 1.431583, 1.445074, 1.458601, 1.472164, 1.485763,
1.499395, 1.513062, 1.526763, 1.540498, 1.554265, 1.568065, 1.581897, 1.595761,
1.609656, 1.623581, 1.637536, 1.651522, 1.665537, 1.679580, 1.693652, 1.707752,
1.721879, 1.736033, 1.750213, 1.764421, 1.778652, 1.792909, 1.807190, 1.821496,
1.835824, 1.850176, 1.864549, 1.878946, 1.893363, 1.907801, 1.922259, 1.936739,
1.951236, 1.965752, 1.980287, 1.994840, 2.009409, 2.023995, 2.038597, 2.053216,
2.067848, 2.082494, 2.097155, 2.111830, 2.126517, 2.141216, 2.155927, 2.170649,
2.185381, 2.200124, 2.214875, 2.229636, 2.244405, 2.259180, 2.273963, 2.288754,
2.303549, 2.318350, 2.333155, 2.347965, 2.362778, 2.377594, 2.392412, 2.407233,
2.422054, 2.436875, 2.451696, 2.466518, 2.481338, 2.496155, 2.510970, 2.525782,
2.540590, 2.555394, 2.570192, 2.584986, 2.599773, 2.614553, 2.629325, 2.644091,
2.658846, 2.673593, 2.688329, 2.703056, 2.717770, 2.732473, 2.747163, 2.761841,
2.776504, 2.791153, 2.805787, 2.820406, 2.835008, 2.849594, 2.864161, 2.878711,
2.893242, 2.907753, 2.922244, 2.936715, 2.951164, 2.965591, 2.979995, 2.994377,
3.008734, 3.023066, 3.037373, 3.051656, 3.065910, 3.080138, 3.094338, 3.108510,
3.122652, 3.136765, 3.150847, 3.164900, 3.178919, 3.192907, 3.206861, 3.220783,
3.234670, 3.248522, 3.262338, 3.276120, 3.289863, 3.303570, 3.317238, 3.330869,
3.344459, 3.358010, 3.371520, 3.384990, 3.398417, 3.411801, 3.425143, 3.438442,
3.451695, 3.464904, 3.478067, 3.491185, 3.504256, 3.517278, 3.530253, 3.543180,
3.556057, 3.568884, 3.581661, 3.594387, 3.607061, 3.619683, 3.632251, 3.644767,
3.657228, 3.669635, 3.681986, 3.694282, 3.706520, 3.718702, 3.730826, 3.742892,
3.754899, 3.766846, 3.778733, 3.790561, 3.802327, 3.814030, 3.825672, 3.837251,
3.848767, 3.860218, 3.871604, 3.882927, 3.894182, 3.905372, 3.916495, 3.927551,
3.938539, 3.949458, 3.960308, 3.971089, 3.981800, 3.992440, 4.003008, 4.013506,
4.023932, 4.034284, 4.044563, 4.054770, 4.064901, 4.074957, 4.084939, 4.094845,
4.104675, 4.114428, 4.124104, 4.133702, 4.143222, 4.152663, 4.162025, 4.171308,
4.180511, 4.189632, 4.198673, 4.207633, 4.216511, 4.225306, 4.234018, 4.242648,
4.251194, 4.259655, 4.268032, 4.276325, 4.284532, 4.292652, 4.300687, 4.308636,
4.316496, 4.324270, 4.331956, 4.339554, 4.347063, 4.354483, 4.361814, 4.369055,
4.376205, 4.383266, 4.390235, 4.397114, 4.403901, 4.410596, 4.417198, 4.423709,
4.430126, 4.436450, 4.442680, 4.448817, 4.454859, 4.460807, 4.466660, 4.472418,
4.478080, 4.483647, 4.489118, 4.494492, 4.499770, 4.504951, 4.510035, 4.515021,
4.519910, 4.524701, 4.529394, 4.533989, 4.538485, 4.542882, 4.547180, 4.551379,
4.555478, 4.559477, 4.563377, 4.567176, 4.570876, 4.574474, 4.577972, 4.581369,
4.584665, 4.587860, 4.590952, 4.593945, 4.596834, 4.599622, 4.602308, 4.604892,
4.607374, 4.609753, 4.612030, 4.614204, 4.616275, 4.618243, 4.620108, 4.621871,
4.623529, 4.625085, 4.626538, 4.627887, 4.629132, 4.630274, 4.631312, 4.632247,
4.633078, 4.633805, 4.634429, 4.634948, 4.635364, 4.635675, 4.635883, 4.635987,
4.635987, 4.635883, 4.635675, 4.635364, 4.634948, 4.634429, 4.633805, 4.633078,
4.632247, 4.631312, 4.630274, 4.629132, 4.627887, 4.626538, 4.625085, 4.623529,
4.621871, 4.620108, 4.618243, 4.616275, 4.614203, 4.612030, 4.609753, 4.607374,
4.604892, 4.602308, 4.599622, 4.596834, 4.593944, 4.590953, 4.587860, 4.584665,
4.581369, 4.577972, 4.574474, 4.570876, 4.567176, 4.563377, 4.559477, 4.555478,
4.551379, 4.547180, 4.542882, 4.538485, 4.533989, 4.529394, 4.524702, 4.519910,
4.515021, 4.510035, 4.504951, 4.499770, 4.494492, 4.489118, 4.483647, 4.478080,
4.472417, 4.466660, 4.460807, 4.454859, 4.448817, 4.442680, 4.436450, 4.430126,
4.423708, 4.417199, 4.410596, 4.403901, 4.397114, 4.390235, 4.383266, 4.376206,
4.369054, 4.361814, 4.354483, 4.347063, 4.339553, 4.331956, 4.324270, 4.316497,
4.308635, 4.300687, 4.292653, 4.284532, 4.276324, 4.268033, 4.259655, 4.251194,
4.242648, 4.234019, 4.225306, 4.216511, 4.207633, 4.198673, 4.189632, 4.180511,
4.171308, 4.162025, 4.152663, 4.143222, 4.133701, 4.124104, 4.114428, 4.104675,
4.094845, 4.084939, 4.074958, 4.064901, 4.054769, 4.044563, 4.034284, 4.023932,
4.013506, 4.003009, 3.992440, 3.981800, 3.971088, 3.960308, 3.949458, 3.938539,
3.927550, 3.916495, 3.905372, 3.894183, 3.882926, 3.871605, 3.860218, 3.848767,
3.837251, 3.825672, 3.814031, 3.802327, 3.790560, 3.778734, 3.766846, 3.754899,
3.742892, 3.730826, 3.718702, 3.706521, 3.694281, 3.681986, 3.669635, 3.657229,
3.644767, 3.632252, 3.619683, 3.607061, 3.594387, 3.581661, 3.568885, 3.556057,
3.543180, 3.530253, 3.517278, 3.504256, 3.491184, 3.478067, 3.464904, 3.451696,
3.438441, 3.425143, 3.411801, 3.398417, 3.384989, 3.371520, 3.358010, 3.344459,
3.330868, 3.317238, 3.303570, 3.289864, 3.276119, 3.262339, 3.248522, 3.234670,
3.220782, 3.206861, 3.192907, 3.178920, 3.164899, 3.150847, 3.136765, 3.122653,
3.108509, 3.094338, 3.080138, 3.065911, 3.051655, 3.037374, 3.023066, 3.008734,
2.994376, 2.979995, 2.965591, 2.951164, 2.936714, 2.922244, 2.907753, 2.893242,
2.878711, 2.864161, 2.849594, 2.835009, 2.820406, 2.805787, 2.791153, 2.776505,
2.761840, 2.747163, 2.732473, 2.717771, 2.703055, 2.688329, 2.673593, 2.658847,
2.644090, 2.629326, 2.614553, 2.599773, 2.584985, 2.570193, 2.555394, 2.540591,
2.525782, 2.510970, 2.496155, 2.481338, 2.466517, 2.451697, 2.436876, 2.422054,
2.407232, 2.392412, 2.377594, 2.362779, 2.347965, 2.333155, 2.318350, 2.303550,
2.288753, 2.273964, 2.259181, 2.244405, 2.229635, 2.214875, 2.200124, 2.185382,
2.170649, 2.155927, 2.141216, 2.126518, 2.111830, 2.097156, 2.082495, 2.067848,
2.053215, 2.038597, 2.023995, 2.009409, 1.994839, 1.980287, 1.965753, 1.951236,
1.936738, 1.922260, 1.907802, 1.893364, 1.878945, 1.864550, 1.850176, 1.835825,
1.821495, 1.807190, 1.792909, 1.778653, 1.764420, 1.750214, 1.736033, 1.721879,
1.707752, 1.693652, 1.679580, 1.665537, 1.651523, 1.637537, 1.623580, 1.609655,
1.595760, 1.581897, 1.568065, 1.554266, 1.540499, 1.526765, 1.513062, 1.499395,
1.485762, 1.472164, 1.458601, 1.445074, 1.431583, 1.418128, 1.404708, 1.391327,
1.377984, 1.364679, 1.351412, 1.338184, 1.324995, 1.311846, 1.298735, 1.285666,
1.272638, 1.259651, 1.246706, 1.233802, 1.220941, 1.208122, 1.195344, 1.182611,
1.169923, 1.157278, 1.144677, 1.132121, 1.119610, 1.107144, 1.094723, 1.082348,
1.070021, 1.057740, 1.045505, 1.033318, 1.021179, 1.009087, 0.997041, 0.985046,
0.973100, 0.961202, 0.949354, 0.937555, 0.925806, 0.914107, 0.902456, 0.890858,
0.879311, 0.867814, 0.856369, 0.844976, 0.833635, 0.822345, 0.811106, 0.799921,
0.788789, 0.777710, 0.766684, 0.755712, 0.744793, 0.733928, 0.723115, 0.712358,
0.701655, 0.691007, 0.680413, 0.669875, 0.659391, 0.648963, 0.638589, 0.628272,
0.618010, 0.607805, 0.597656, 0.587562, 0.577526, 0.567545, 0.557620, 0.547753,
0.537943, 0.528190, 0.518494, 0.508855, 0.499274, 0.489750, 0.480283, 0.470874,
0.461523, 0.452230, 0.442995, 0.433819, 0.424700, 0.415639, 0.406636, 0.397692,
0.388806, 0.379979, 0.371211, 0.362501, 0.353850, 0.345258, 0.336723, 0.328248,
0.319832, 0.311475, 0.303177, 0.294937, 0.286757, 0.278636, 0.270572, 0.262569,
0.254624, 0.246739, 0.238912, 0.231145, 0.223437, 0.215788, 0.208196, 0.200665,
0.193193, 0.185779, 0.178425, 0.171129, 0.163892, 0.156715, 0.149594, 0.142534,
0.135532, 0.128589, 0.121705, 0.114879, 0.108112, 0.101403, 0.094751, 0.088159,
0.081625, 0.075149, 0.068731, 0.062371, 0.056069, 0.049825, 0.043638, 0.037509,
0.031438, 0.025424, 0.019468, 0.013569, 0.007727, 0.001942, -0.003787, -0.009458,
-0.015072, -0.020630, -0.026132, -0.031577, -0.036966, -0.042299, -0.047576, -0.052798,
-0.057963, -0.063073, -0.068128, -0.073127, -0.078071, -0.082961, -0.087796, -0.092576,
-0.097302, -0.101973, -0.106590, -0.111153, -0.115663, -0.120118, -0.124521, -0.128870,
-0.133166, -0.137409, -0.141599, -0.145737, -0.149822, -0.153856, -0.157837, -0.161767,
-0.165645, -0.169471, -0.173246, -0.176970, -0.180644, -0.184266, -0.187839, -0.191362,
-0.194834, -0.198256, -0.201629, -0.204953, -0.208227, -0.211453, -0.214630, -0.217759,
-0.220839, -0.223871, -0.226855, -0.229792, -0.232682, -0.235524, -0.238320, -0.241069,
-0.243771, -0.246428, -0.249038, -0.251603, -0.254123, -0.256597, -0.259026, -0.261411,
-0.263751, -0.266047, -0.268299, -0.270507, -0.272672, -0.274793, -0.276872, -0.278908,
-0.280901, -0.282853, -0.284762, -0.286630, -0.288456, -0.290241, -0.291985, -0.293689,
-0.295352, -0.296975, -0.298559, -0.300102, -0.301607, -0.303072, -0.304499, -0.305887,
-0.307236, -0.308548, -0.309822, -0.311059, -0.312258, -0.313421, -0.314547, -0.315637,
-0.316690, -0.317708, -0.318690, -0.319637, -0.320549, -0.321427, -0.322270, -0.323078,
-0.323853, -0.324594, -0.325302, -0.325977, -0.326619, -0.327228, -0.327806, -0.328351,
-0.328865, -0.329347, -0.329798, -0.330218, -0.330608, -0.330968, -0.331297, -0.331597,
-0.331867, -0.332108, -0.332320, -0.332504, -0.332659, -0.332786, -0.332885, -0.332957,
-0.333001, -0.333018, -0.333009, -0.332973, -0.332912, -0.332824, -0.332710, -0.332572,
-0.332408, -0.332219, -0.332006, -0.331769, -0.331508, -0.331222, -0.330914, -0.330582,
-0.330228, -0.329850, -0.329451, -0.329029, -0.328585, -0.328120, -0.327634, -0.327126,
-0.326598, -0.326049, -0.325480, -0.324891, -0.324282, -0.323654, -0.323006, -0.322340,
-0.321654, -0.320951, -0.320229, -0.319489, -0.318732, -0.317957, -0.317165, -0.316356,
-0.315530, -0.314688, -0.313830, -0.312955, -0.312066, -0.311160, -0.310239, -0.309304,
-0.308354, -0.307389, -0.306410, -0.305417, -0.304411, -0.303391, -0.302357, -0.301311,
-0.300251, -0.299179, -0.298095, -0.296999, -0.295891, -0.294771, -0.293639, -0.292497,
-0.291343, -0.290179, -0.289004, -0.287819, -0.286624, -0.285419, -0.284204, -0.282980,
-0.281747, -0.280504, -0.279253, -0.277993, -0.276725, -0.275449, -0.274164, -0.272872,
-0.271572, -0.270265, -0.268951, -0.267630, -0.266302, -0.264968, -0.263626, -0.262279,
-0.260927, -0.259568, -0.258203, -0.256834, -0.255459, -0.254079, -0.252693, -0.251304,
-0.249910, -0.248512, -0.247109, -0.245703, -0.244292, -0.242879, -0.241461, -0.240041,
-0.238617, -0.237191, -0.235762, -0.234330, -0.232896, -0.231459, -0.230020, -0.228580,
-0.227138, -0.225694, -0.224248, -0.222802, -0.221354, -0.219905, -0.218455, -0.217005,
-0.215554, -0.214102, -0.212651, -0.211199, -0.209747, -0.208295, -0.206844, -0.205393,
-0.203943, -0.202493, -0.201044, -0.199596, -0.198149, -0.196704, -0.195259, -0.193816,
-0.192375, -0.190936, -0.189498, -0.188062, -0.186628, -0.185197, -0.183767, -0.182340,
-0.180916, -0.179494, -0.178075, -0.176659, -0.175246, -0.173835, -0.172428, -0.171024,
-0.169624, -0.168227, -0.166833, -0.165443, -0.164057, -0.162675, -0.161296, -0.159922,
-0.158551, -0.157185, -0.155823, -0.154465, -0.153112, -0.151763, -0.150419, -0.149080,
-0.147745, -0.146415, -0.145090, -0.143770, -0.142455, -0.141145, -0.139840, -0.138540,
-0.137246, -0.135957, -0.134674, -0.133396, -0.132124, -0.130857, -0.129595, -0.128340,
-0.127090, -0.125847, -0.124609, -0.123377, -0.122151, -0.120931, -0.119717, -0.118509,
-0.117308, -0.116112, -0.114923, -0.113740, -0.112564, -0.111394, -0.110230, -0.109073,
-0.107923, -0.106779, -0.105641, -0.104510, -0.103386, -0.102268, -0.101157, -0.100053,
-0.098956, -0.097865, -0.096781, -0.095704, -0.094634, -0.093571, -0.092514, -0.091464,
-0.090422, -0.089386, -0.088357, -0.087336, -0.086321, -0.085313, -0.084312, -0.083319,
-0.082332, -0.081352, -0.080380, -0.079414, -0.078456, -0.077504, -0.076560, -0.075623,
-0.074693, -0.073770, -0.072854, -0.071945, -0.071043, -0.070148, -0.069261, -0.068380,
-0.067507, -0.066640, -0.065781, -0.064929, -0.064084, -0.063246, -0.062415, -0.061591,
-0.060774, -0.059964, -0.059161, -0.058365, -0.057576, -0.056794, -0.056018, -0.055250,
-0.054489, -0.053735, -0.052987, -0.052247, -0.051513, -0.050786, -0.050066, -0.049353,
-0.048646, -0.047946, -0.047253, -0.046567, -0.045888, -0.045215, -0.044548, -0.043888,
-0.043235, -0.042589, -0.041949, -0.041315, -0.040688, -0.040068, -0.039454, -0.038846,
-0.038245, -0.037650, -0.037061, -0.036479, -0.035903, -0.035333, -0.034769, -0.034211,
-0.033660, -0.033115, -0.032576, -0.032042, -0.031515, -0.030994, -0.030479, -0.029970,
-0.029466, -0.028968, -0.028477, -0.027991, -0.027510, -0.027036, -0.026567, -0.026103,
-0.025645, -0.025193, -0.024746, -0.024305, -0.023870, -0.023439, -0.023014, -0.022594,
-0.022180, -0.021771, -0.021367, -0.020968, -0.020575, -0.020186, -0.019803, -0.019424,
-0.019051, -0.018683, -0.018319, -0.017960, -0.017606, -0.017257, -0.016913, -0.016574,
-0.016239, -0.015908, -0.015583, -0.015262, -0.014945, -0.014633, -0.014326, -0.014022,
-0.013723, -0.013429, -0.013139, -0.012853, -0.012571, -0.012294, -0.012020, -0.011751,
-0.011486, -0.011224, -0.010967, -0.010714, -0.010465, -0.010219, -0.009977, -0.009740,
-0.009505, -0.009275, -0.009048, -0.008826, -0.008606, -0.008390, -0.008178, -0.007969,
-0.007764, -0.007562, -0.007364, -0.007169, -0.006977, -0.006789, -0.006604, -0.006422,
-0.006243, -0.006068, -0.005896, -0.005726, -0.005560, -0.005397, -0.005237, -0.005080,
-0.004926, -0.004774, -0.004626, -0.004480, -0.004338, -0.004198, -0.004061, -0.003926,
-0.003795, -0.003666, -0.003539, -0.003416, -0.003295, -0.003176, -0.003060, -0.002947,
-0.002836, -0.002727, -0.002621, -0.002517, -0.002416, -0.002317, -0.002221, -0.002126,
-0.002035, -0.001945, -0.001858, -0.001773, -0.001690, -0.001609, -0.001530, -0.001454,
-0.001380, -0.001308, -0.001238, -0.001170, -0.001104, -0.001040, -0.000978, -0.000919,
-0.000861, -0.000805, -0.000751, -0.000700, -0.000650, -0.000602, -0.000556, -0.000511,
-0.000469, -0.000429, -0.000390, -0.000354, -0.000319, -0.000286, -0.000255, -0.000226,
-0.000198, -0.000173, -0.000149, -0.000127, -0.000106, -0.000088, -0.000071, -0.000056,
-0.000043, -0.000032, -0.000022, -0.000014, -0.000008, -0.000004, -0.000001, 0.000000
};

// FFT buffer
float signal[4096];

// Phases of the signal
float signal_phase = 0;

volatile uint32_t TimingDelay;

//  USB related
volatile uint8_t TestBuffer[27];
extern volatile uint8_t Receive_Buffer[64];
extern volatile uint32_t Receive_length ;
extern volatile uint32_t length ;
uint8_t Send_Buffer[64];
uint32_t packet_sent=1;
uint32_t packet_receive=1;

void Delay(volatile uint32_t nTime) {
    TimingDelay = nTime;
    while(TimingDelay != 0);
}

#define PI        3.1415926535897932384626433832795
#define DEG2RAD   0.01745329251994329576923690768489
#define RAD2DEG   57.295779513082320876798154814105  // 180/PI
#define EPSILON   1e-8 // Small value for zero comparison

// Calculates the FFT phase at a given frequency index.
// Input: data is complex FFT Re[V(0)],Im[V(0)], Re[V(1)],Im[V(1)],...
// Input: nn is the number of points in the data and in the FFT,
//           nn must be a power of 2
// Input: k is frequency index 0 to nn/2-1
//        E.g., if nn = 4096, then k can be 0 to 2047
// Output: Phase at this frequency
// data is an array of 2*nn elements
// returns 0 if k >= nn/2
float myfftPhase (float data[], unsigned long nn, uint16_t k) {
    if (k >= nn / 2) {
        return 0.0; // out of range
    }

    // Extract the real and imaginary parts of the k-th element
    float real_part = data[2 * k];
    float imag_part = data[2 * k + 1];

    // Handle the case when both real and imaginary parts are zero (undefined phase)
    if (fabs(real_part) < EPSILON && fabs(imag_part) < EPSILON) {
        return 0.0; // phase is undefined
    }

    // Calculate the angle in radians using atan2
    float angle_rad = atan2(imag_part, real_part);

    // Convert the angle to degrees
    float angle_deg = angle_rad * RAD2DEG;

    angle_deg -= 222.884444;

    // Normalize the angle to be in the range [0, 360)
    if (angle_deg < 0) {
        angle_deg += 360.0;
    }

    // Adjust phase based on phase difference between bin 9 an 50 Hz
    // ( Value is not equal to theory, like always :))) )
    //angle_deg = fmodf((angle_deg - 222.884444), 360.0);

    // Normalize the angle to be in the range [0, 360)
    if (angle_deg < 0) {
        angle_deg += 360.0;
    }

    return angle_deg;
}

// Apply the Flat Top window to the signal
void apply_flattop_window(float *signal, const float *flattop_window, uint16_t num_points) {
    for (size_t n = 0; n < num_points; n++) {
        signal[n * 2] = signal[n * 2] * flattop_window[n]; // Apply the window to the real part
    }
}

// Helper macro to swap two float values
#define SWAP(a, b) { float temp = (a); (a) = (b); (b) = temp; }

// FFT optimized for a signal array only with real side values, no imaginary
// Input: nn is the number of points in the data and in the FFT (must be a power of 2).
// Input: data is an array of nn real elements (no imaginary part initially, from ADC)
//        Re(0),0,Re(1),0,Re(2),...Re(nn-1),0
// Output: data will be transformed to contain complex FFT coefficients where the real
//         and imaginary parts are interleaved in the same array (Re, Im, Re, Im...).
void real_fft (float data[], unsigned long nn) {
    unsigned long n, mmax, m, j, istep, i;
    double wtemp, wr, wpr, wpi, wi, theta;
    double tempr, tempi;

    // `nn` is the number of real samples. In the complex FFT,
    // `n` will be twice `nn` because each complex number has two parts (Re and Im).
    n = nn << 1;  // n = 2 * nn, for real + imaginary storage (even though input is real, output will be complex)

    // ---- Bit-reversal Reordering ----
    // The FFT requires the input to be in bit-reversed order to optimize
    // in-place computation. Here we rearrange the data in such order.
    j = 1;
    for (i = 1; i < n; i += 2) {
        if (j > i) {  // Swap only if j > i to avoid swapping elements back
            SWAP(data[j-1], data[i-1]);  // Swap the real part
            SWAP(data[j], data[i]);      // Swap the imaginary part (initially 0)
        }

        // Bit-reversal logic (this shifts the bits around in a specific way
        // to reorder the data).
        m = n >> 1;
        while (m >= 2 && j > m) {
            j -= m;
            m >>= 1;
        }
        j += m;
    }

    // ---- Danielson-Lanczos Recursion ----
    // This is the heart of the FFT algorithm, where the computation is performed
    // in a recursive, divide-and-conquer manner.
    mmax = 2;  // mmax starts at 2 (which means we first handle 2-element blocks)
    while (n > mmax) {
        istep = mmax << 1;  // Step size for each FFT recursion level (block size)

        // Calculate the angle (theta) for the trigonometric recurrence relation
        // that is used to compute the FFT (twiddle factors).
        theta = -2.0 * PI / mmax;
        wtemp = sin(0.5 * theta);
        wpr = -2.0 * wtemp * wtemp;  // Real part of twiddle factor
        wpi = sin(theta);            // Imaginary part of twiddle factor
        wr = 1.0;                    // Starting value for twiddle real part (cos(0) = 1)
        wi = 0.0;                    // Starting value for twiddle imaginary part (sin(0) = 0)

        // For each recursion level, we loop through the data in chunks
        // of size `mmax`, computing the FFT step for each pair of elements.
        for (m = 1; m < mmax; m += 2) {
            for (i = m; i <= n; i += istep) {
                // The FFT is performed in pairs of elements. We compute the
                // real and imaginary parts of these elements and apply the twiddle factors.
                j = i + mmax;  // This is the other element in the pair

                // Calculate the real and imaginary components of the twiddle factor for this step
                tempr = wr * data[j-1] - wi * data[j];
                tempi = wr * data[j] + wi * data[j-1];

                // Update the real and imaginary parts with the calculated values
                data[j-1] = data[i-1] - tempr;
                data[j]   = data[i]   - tempi;
                data[i-1] = data[i-1] + tempr;
                data[i]   = data[i]   + tempi;
            }

            // Update the twiddle factors for the next iteration. This is done
            // using the recurrence relation for trigonometric functions.
            wtemp = wr;
            wr = wr * wpr - wi * wpi + wr;
            wi = wi * wpr + wtemp * wpi + wi;
        }

        // Double the block size for the next level of recursion.
        mmax = istep;
    }
}

// Adjust the phase to be an integer with `2 decimals` ( * 100)
uint16_t adjust_phase(float phase, float phase_difference) {
    // If phase difference it to big something is broken
    if (phase_difference >= 359.0)  // THE DWT TICKS COUNTER HAS GONE WHILD ON US !!! :)
        return 0;

    // Subtract the small delay from the moment we had zero-cross impulse
    // till the moment the ADC had first data ready (/DRA high)
    float adjusted_phase = phase - phase_difference;

    // Ensure the result is in the range [0, 360)
    if (adjusted_phase < 0) {
        adjusted_phase += 360.0;
    }

    // Scale by 100 and return as an integer. We keep two decimals of precision
    return (uint16_t)(adjusted_phase * 100.0);
}

// Adjust the voltage so that we have current only in 0..100 mA
uint16_t adjust_voltage (float voltage) {
    uint16_t voltage_value = 0;

    // Prevent negative values
    if (voltage < 0)
        return 0;

    // Scale by 10000 and convert to integer
    // The ADC `sees` voltage up to 0.6V without degraded precision
    voltage_value = (uint16_t)(voltage * 10000.0);

    // Top voltage at 100 mA (0.1 A * 5.6 OHM = 0.56 V * 10000.0 = 5600)
    if (voltage_value > 5600)
        return 5600;

    return voltage_value;
}

// Generate sine wave of specific phase and amplitude, with added noise
void generate_sine_wave(float *signal, uint16_t num_points, float rms_amplitude, float frequency, float sample_rate, float phase_degrees, float noise_amplitude) {
    // Convert phase from degrees to radians
    float phase_radians = phase_degrees * (PI / 180.0);

    // Calculate peak amplitude from RMS
    float peak_amplitude = rms_amplitude * sqrt(2.0);

    int k = 0;
    for (uint16_t i = 0; i < num_points * 2; i += 2) {
        // Calculate time based on sample rate
        float time = (float)k / sample_rate;

        // Generate sine wave value with phase
        // Real part
        float sine_value = peak_amplitude * sin(2.0 * PI * frequency * time + phase_radians);

        // Add noise to the sine wave value
        float noise = ((float)rand() / RAND_MAX) * 2.0f * noise_amplitude - noise_amplitude; // Noise in range [-noise_amplitude, noise_amplitude]

        signal[i] = sine_value + noise; // Add noise to the sine wave

        // Imaginary part
        signal[i + 1] = 0.0;

        k += 1;
    }
}

void print2usb(char *s) {
    if (s == NULL) {
        return; // Handle null pointer
    }

    int str_len = strlen(s); // Get the length of the string
    CDC_Send_DATA((unsigned char*)s, str_len); // Send the string to USB
    Delay(10);
}

void print2usb_int(uint32_t number) {
    // Buffer to hold the string representation of the integer
    char buffer[12]; // Enough for a 64-bit integer including sign
    char *ptr = buffer; // Pointer to traverse the buffer

    // Handle negative values
    if (number < 0) {
        *ptr++ = '-';
        number = -number; // Convert to positive for further processing
    }

    // Build the string in reverse
    if (number == 0) {
        *ptr++ = '0'; // Handle zero explicitly
    } else {
        // Convert integer to string
        int i = 0; // Index for digits
        while (number > 0) {
            buffer[i++] = '0' + (number % 10); // Get the last digit
            number /= 10; // Remove the last digit
        }

        // Reverse the digits in the buffer
        for (int j = 0; j < i / 2; j++) {
            char temp = buffer[j];
            buffer[j] = buffer[i - 1 - j];
            buffer[i - 1 - j] = temp;
        }
        ptr = buffer + i; // Update ptr to point to the end of the digits
    }

    // Null-terminate the string
    *ptr = '\0';

    // Send the constructed string over USB
    CDC_Send_DATA((unsigned char*)buffer, strlen(buffer));
    Delay(10);
}

int main(void) {
    GPIO_InitTypeDef GPIO_InitStructure;

    /************************************************************
    *   Set the Vector Table base adress at 0x8004000
    *************************************************************/
    NVIC_SetVectorTable(NVIC_VectTab_FLASH, 0x4000);

    // Set Systick to 1 ms interrupt (72 MHz clock)
    if(SysTick_Config(72000))
    {
        /* Capture error */
        while (1);
    }

    /************************************************************
    *   init PB0 led
    *************************************************************/
    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB , ENABLE);
    GPIO_StructInit(&GPIO_InitStructure);
    GPIO_InitStructure.GPIO_Pin = GPIO_Pin_1 | GPIO_Pin_0;
    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;
    GPIO_Init(GPIOB, &GPIO_InitStructure);

    /*************************************************************
    *   Init USB peripheral
    *************************************************************/
    Set_System();
    Set_USBClock();
    USB_Interrupts_Config();
    USB_Init();

    // Small delay so the user can open the new COM port in Termite 
    Delay(3000);

    const uint16_t num_points = 2048;    // Number of points in the buffer
    const float rms_amplitude = 0.025;   // RMS amplitude in volts
    const float frequency = 50.0;        // Frequency in Hz
    const float sample_rate = 11718.75;  // Sample rate in Hz (calculated to get index 9)
    float signal_phase = 0.0;
    float noise_aplitude = 0.002;

    while (signal_phase < 360.0) {
        // Generate the sine wave
        generate_sine_wave(signal, num_points, rms_amplitude, frequency, sample_rate, signal_phase, noise_aplitude);
        // Apply Flat Top window to the signal
        apply_flattop_window(signal, flattop_window, num_points);
        // Compute FFT
        real_fft(signal, 2048);
        // Compute signal phase
        float phase = myfftPhase(signal, 2048, 9);

        // Multiply by 10000 and convert to integer
        uint32_t sp = signal_phase * 10000.0;
        uint32_t p = phase * 10000.0;

        print2usb("\nPhase of signal:");
        print2usb_int(sp);
        print2usb(",Computed phase:");
        print2usb_int(p);

        // Toggle led
        GPIOB->ODR ^= GPIO_Pin_0;

        signal_phase += 2.5;
    }
}

/*
// If we need to store signed values we use 2's complement
// int16_t val = -100;
// uint16_t number = (uint16_t) val


#define TO_HEX(i) (i <= 9 ? '0' + i : 'A' - 10 + i)

void USBSERIAL_Print_Hex(uint16_t x)
{
    uint8_t res[5];

    if (x <= 0xFFFF)
    {
        res[0] = TO_HEX(((x & 0xF000) >> 12));
        res[1] = TO_HEX(((x & 0x0F00) >> 8));
        res[2] = TO_HEX(((x & 0x00F0) >> 4));
        res[3] = TO_HEX((x & 0x000F));
        res[4] = '\n';
    }
    CDC_Send_DATA ((uint8_t *)res,5);
}
*/
